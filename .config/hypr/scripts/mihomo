#!/bin/bash

# Mihomo 配置
CONFIG_DIR="$HOME/.config/mihomo"
MIHOMO_CMD="mihomo"
LOG_FILE="$CONFIG_DIR/mihomo.log"
PID_FILE="/tmp/mihomo.pid"

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 检查是否已安装 mihomo
check_mihomo() {
    if ! command -v $MIHOMO_CMD &> /dev/null; then
        echo -e "${RED}错误: 未找到 $MIHOMO_CMD 命令${NC}"
        echo "请确保已安装 mihomo"
        exit 1
    fi
}

# 检查配置文件目录
check_config() {
    if [ ! -d "$CONFIG_DIR" ]; then
        echo -e "${YELLOW}警告: 配置目录 $CONFIG_DIR 不存在${NC}"
        echo "将使用默认配置"
    fi
}

# 启动 Mihomo
start_mihomo() {
    check_mihomo
    check_config
    
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p $PID > /dev/null 2>&1; then
            echo -e "${YELLOW}Mihomo 已经在运行 (PID: $PID)${NC}"
            return 0
        else
            echo -e "${YELLOW}发现旧的 PID 文件，正在清理...${NC}"
            rm -f "$PID_FILE"
        fi
    fi
    
    echo -e "${BLUE}正在启动 Mihomo...${NC}"
    
    # 以守护进程模式启动 Mihomo
    $MIHOMO_CMD -d "$CONFIG_DIR" >> "$LOG_FILE" 2>&1 &
    
    PID=$!
    echo $PID > "$PID_FILE"
    
    sleep 2
    
    if ps -p $PID > /dev/null 2>&1; then
        echo -e "${GREEN}✓ Mihomo 启动成功 (PID: $PID)${NC}"
        echo "日志文件: $LOG_FILE"
        echo "PID 文件: $PID_FILE"
    else
        echo -e "${RED}✗ Mihomo 启动失败${NC}"
        echo "请检查日志: $LOG_FILE"
        rm -f "$PID_FILE"
        return 1
    fi
}

# 停止 Mihomo
stop_mihomo() {
    if [ ! -f "$PID_FILE" ]; then
        echo -e "${YELLOW}Mihomo 未运行${NC}"
        return 0
    fi
    
    PID=$(cat "$PID_FILE")
    
    if ps -p $PID > /dev/null 2>&1; then
        echo -e "${BLUE}正在停止 Mihomo (PID: $PID)...${NC}"
        kill $PID
        
        # 等待进程结束
        for i in {1..10}; do
            if ! ps -p $PID > /dev/null 2>&1; then
                break
            fi
            sleep 1
        done
        
        if ps -p $PID > /dev/null 2>&1; then
            echo -e "${YELLOW}强制停止 Mihomo...${NC}"
            kill -9 $PID
        fi
    fi
    
    rm -f "$PID_FILE"
    echo -e "${GREEN}✓ Mihomo 已停止${NC}"
}

# 重启 Mihomo
restart_mihomo() {
    echo -e "${BLUE}正在重启 Mihomo...${NC}"
    stop_mihomo
    sleep 2
    start_mihomo
}

# 查看状态
status_mihomo() {
    if [ -f "$PID_FILE" ]; then
        PID=$(cat "$PID_FILE")
        if ps -p $PID > /dev/null 2>&1; then
            echo -e "${GREEN}✓ Mihomo 正在运行 (PID: $PID)${NC}"
            return 0
        else
            echo -e "${YELLOW}⚠ Mihomo 进程异常 (PID: $PID 不存在)${NC}"
            return 1
        fi
    else
        echo -e "${YELLOW}Mihomo 未运行${NC}"
        return 2
    fi
}

# 查看日志
show_log() {
    if [ -f "$LOG_FILE" ]; then
        echo -e "${BLUE}=== Mihomo 日志 (最后 20 行) ===${NC}"
        tail -n 20 "$LOG_FILE"
    else
        echo -e "${YELLOW}日志文件不存在${NC}"
    fi
}

# 显示帮助
show_help() {
    echo "Mihomo 服务管理脚本"
    echo ""
    echo "用法: $0 [选项]"
    echo ""
    echo "选项:"
    echo "  start    启动 Mihomo"
    echo "  stop     停止 Mihomo"
    echo "  restart  重启 Mihomo"
    echo "  status   查看状态"
    echo "  log      查看日志"
    echo "  help     显示此帮助信息"
    echo ""
    echo "配置目录: $CONFIG_DIR"
}

# 主函数
main() {
    case "$1" in
        start)
            start_mihomo
            ;;
        stop)
            stop_mihomo
            ;;
        restart)
            restart_mihomo
            ;;
        status)
            status_mihomo
            ;;
        log)
            show_log
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            if [ -z "$1" ]; then
                # 如果没有参数，默认启动
                start_mihomo
            else
                echo -e "${RED}未知选项: $1${NC}"
                show_help
                exit 1
            fi
            ;;
    esac
}

# 运行主函数
main "$@"
